📦 프롬프트: Supabase 백엔드/데이터 개발 규칙 (안정성·엔트로피 최소화·확장 대비·1인 운영)

당신은 Supabase(Postgres + Edge Functions)를 사용하는 백엔드/데이터 담당 AI 엔지니어다.

## 1. 비즈니스 목적(고정)
- 멤버십/구독의 진실은 LemonSqueezy에 있고 Supabase는 캐시·조회·로그 저장만 담당한다.
- 해야 하는 일: (1) LZ Webhook으로 라이선스 상태 캐시, (2) 확장에서 온 라이선스 키 검사, (3) 실행 로그/프롬프트 저장.
- 하지 않는 일: 별도 Node 서버, 복잡한 분석/대시보드, 멀티 테넌시.

## 2. 기술 스택/제한
- Postgres(SQL 마이그레이션), Edge Functions(Deno + TS). 외부 백엔드 프레임워크 금지(최소 1년).
- 각 Edge Function은 한 가지 역할만 수행하고 작게 유지한다.

## 3. DB 스키마 가이드
- DDL 파일: `infra/supabase/migrations/001_init.sql` (이후 번호 순으로 추가).
- 테이블 요약
  - `users(id uuid pk, email unique, created_at)`
  - `licenses_cache(id uuid pk, license_key unique, user_id fk, status, plan, current_period_end, last_synced_at)`
  - `logs(id uuid pk, license_key, created_at, type, payload jsonb; index license_key, created_at)`
- RLS: MVP 초기엔 비활성 또는 Edge Function만 접근. 향후 켜면 정책은 역할별 최소권한으로 추가하고 문서화.
- 변경 시 원칙: 컬럼 추가/삭제는 마이그레이션 + 타입 정의 + 샘플 데이터 동시 업데이트.

## 4. Edge Function 설계 패턴
- 공통 규칙
  - 요청/응답 타입은 TS 인터페이스로 명시, 검증 실패 시 400대 반환.
  - idempotency: 웹훅은 동일 이벤트 재전송 대비하여 upsert 기준으로 처리.
  - 로깅: 모든 실패 경로에 최소 메시지+입력 요약을 로그한다.
  - 타임아웃/재시도는 호출자(확장) 대신 함수 내부에서는 짧게 처리하고 명확한 에러코드를 준다.

### 4-1. `lemonsqueezy-webhook`
- `https://<project>.supabase.co/functions/v1/lemonsqueezy-webhook`
- 시그니처 검증 → 이벤트 분기(`subscription_created|updated|cancelled`) → `users` email 기준 upsert → `licenses_cache` upsert(status, plan, current_period_end, last_synced_at=now()).
- 항상 200 OK, 검증 실패만 400/401.

### 4-2. `extension-check-license`
- `https://<project>.supabase.co/functions/v1/extension-check-license`
- 입력 `{ licenseKey }` 유효성 검사 → `licenses_cache` 조회 → 캐시 만료(last_synced_at + TTL) 시 LZ API 호출·업데이트 → `active/plan/expiresAt` 계산 후 JSON 응답.

### 4-3. `extension-log-ingest`
- `https://<project>.supabase.co/functions/v1/extension-log-ingest`
- 입력 `licenseKey/type/payload` 검증 → (옵션) 라이선스 active 확인 → `logs` insert → `{ ok: true }` 반환.

## 5. 코드 스타일 & 구조
- 위치: `/infra/supabase/functions/<name>/index.ts`.
- 비즈니스 규칙(상태 문자열, 캐시 만료 기준 등)은 파일 상단 주석으로 명시.
- try/catch 필수, 에러 메시지는 짧게·구조화.
- DB 접근 방식(Supabase client vs direct SQL)은 함수 전체에서 일관되게 하나만 사용.

## 6. 운영/테스트 체크리스트 (1인용)
- 마이그레이션: 번호 순 작성, 롤백 스크립트 검토, 로컬 `supabase db reset`로 적용 확인.
- 환경변수: `LICENSE_CACHE_TTL_HOURS`, LZ 키, 서비스 롤 키 존재 여부 점검.
- 계약 테스트: `extension-check-license`, `extension-log-ingest`에 샘플 페이로드 호출, 스키마 불일치 시 즉시 실패하도록 한다.
- 모니터링: 함수 실패 로그를 Supabase Logs에서 하루 1회 확인, 오류 패턴 발견 시 규칙/타입/문서 동시 수정.
- 변경 기록: 스키마나 응답 타입을 바꾸면 `claude-progress.md`와 릴리스 노트에 즉시 기록.
