## 1. 환경 변수 전략 (안정성/엔트로피 최소화)
- **비밀(Secret)**: Supabase Edge Functions `.env` 전용 (서비스 롤 키, LZ API 키·웹훅 시크릿 등).
- **공개(Public)**: 크롬 확장 `.env` 또는 `config.ts` (project ref, anon key, function base URL 등).
- 규칙: 비밀은 빌드 산출물에 절대 포함 금지. 공개 값도 `APP_ENV` 단위로 분리해 오배포를 막는다.
- 새 값 추가 시: `env.sample` → Supabase Dashboard → 빌드 스크립트 순으로 즉시 반영하고 기록한다.
- **서비스 롤 키 절대 금지**: 크롬 확장/프런트엔드에 `SERVICE_ROLE_KEY`를 절대 넣지 않는다. Edge Function/서버 전용.
- **LemonSqueezy 키 정리**: `docs/llm-context/LEMONSQUEEZY.txt` 등의 노출 키는 즉시 삭제·재발급 후 기록 업데이트.

---

## 2. Supabase(서버)용 `.env` 템플릿
위치 예: `infra/supabase/.env` (배포 시 Supabase Dashboard 환경 변수와 동일하게 유지).

```bash
# infra/supabase/.env

# Supabase 기본
SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# 노출 금지 주석: SERVICE_ROLE_KEY는 Edge Function 전용. 브라우저/확장에 주입 금지.

# LemonSqueezy 설정
LEMONSQUEEZY_API_KEY=ls_live_XXXXXXXXXXXXXXXX
LEMONSQUEEZY_WEBHOOK_SECRET=whsec_XXXXXXXXXXXXXXXX
LEMONSQUEEZY_STORE_ID=12345

# 라이선스 캐시 전략
LICENSE_CACHE_TTL_HOURS=24

# 로그/디버그
LOG_LEVEL=info   # or debug
NODE_ENV=production
```
> Edge Function 전용. 브라우저/확장에 노출 금지.

**운영 팁**
- DEV/PROD 키 완전 분리, 롤백 시에도 동일 키셋 유지.
- 캐시 TTL·LOG_LEVEL 등은 코드 하드코딩 금지, 모두 env 로드.
- 새 비밀 추가 시 `env.sample`와 Dashboard를 동시에 갱신하고, 배포 노트에 적는다.

---

## 3. 크롬 확장용 `.env` / `config.ts`
빌드 도구는 이후 결정, 값만 합의.

### 3-1. `.env` 예시
```bash
# chrome-extension/.env
APP_ENV=development   # staging, production 만 추가
SUPABASE_PROJECT_REF=YOUR_PROJECT_REF
SUPABASE_ANON_KEY=your-public-anon-key-here
SUPABASE_FUNCTION_BASE_URL=https://YOUR_PROJECT_REF.functions.supabase.co
# 주의: 확장에는 ANON_KEY만 사용. SERVICE_ROLE_KEY는 사용 금지.
```

### 3-2. `config.ts` 예시
```ts
// chrome-extension/src/config.ts
export const APP_ENV = 'development' as const
export const SUPABASE_PROJECT_REF = 'YOUR_PROJECT_REF'
export const SUPABASE_ANON_KEY = 'your-public-anon-key-here'
export const SUPABASE_FUNCTION_BASE_URL =
  `https://${SUPABASE_PROJECT_REF}.functions.supabase.co`
export const FUNCTION_ENDPOINTS = {
  CHECK_LICENSE: `${SUPABASE_FUNCTION_BASE_URL}/extension-check-license`,
  LOG_INGEST: `${SUPABASE_FUNCTION_BASE_URL}/extension-log-ingest`,
}
```
> 빌드 파이프라인 정리 전까지는 하드코딩 허용, 이후 `.env` → `config.ts` 주입.

### 실패 안전
- `postJson` 등 API 래퍼에서 응답 스키마 불일치 시 오류를 즉시 던지고 상위에서 사용자 메시지 처리.
- 네트워크 오류는 1회 재시도(백오프) 혹은 graceful 실패 메시지.

---

## 4. Supabase Edge Function URL 패턴
- 기본: `https://<PROJECT_REF>.functions.supabase.co/<function-name>`
- 이 프로젝트: `extension-check-license`, `extension-log-ingest`, `lemonsqueezy-webhook`
- 확장에서는 `CHECK_LICENSE`, `LOG_INGEST` 두 개만 사용. 웹훅은 LZ 설정에만 사용.

---

## 5. TypeScript 타입 스켈레톤
확장 ↔ Supabase 계약 고정용. 변경 시 버전 기록 필수.

```ts
// common-types.ts
export type PlanId = 'FREE' | 'PRO'
export type LicenseStatusRaw = 'active' | 'cancelled' | 'past_due' | 'expired' | 'trialing'
export interface CheckLicenseRequest { licenseKey: string }
export interface CheckLicenseResponse { active: boolean; plan: PlanId; expiresAt: string | null }
export type LogType = 'run' | 'error' | 'prompt'
export interface LogIngestRequest { licenseKey: string; type: LogType; payload: unknown }
export interface LogIngestResponse { ok: boolean }
```

### 확장 API 클라이언트 스켈레톤
```ts
// chrome-extension/src/api/supabaseClient.ts
import { CheckLicenseRequest, CheckLicenseResponse, LogIngestRequest, LogIngestResponse } from './types'
import { FUNCTION_ENDPOINTS } from '../config'

async function postJson<TReq, TRes>(url: string, body: TReq): Promise<TRes> {
  const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
  if (!res.ok) throw new Error(`Request failed: ${res.status}`)
  return (await res.json()) as TRes
}

export const checkLicense = (licenseKey: string) =>
  postJson<CheckLicenseRequest, CheckLicenseResponse>(FUNCTION_ENDPOINTS.CHECK_LICENSE, { licenseKey })

export const sendLog = (req: LogIngestRequest) =>
  postJson<LogIngestRequest, LogIngestResponse>(FUNCTION_ENDPOINTS.LOG_INGEST, req)
```

### Edge Function 타입 스켈레톤
- `extension-check-license`: 캐시 TTL은 env에서 로드, 캐시 만료 시 LZ API 호출 → `licenses_cache` 업데이트 후 응답.
- `extension-log-ingest`: payload 검증 → (옵션) 라이선스 활성 여부 확인 → `logs` insert.
- `lemonsqueezy-webhook`: 시그니처 검증 → 이벤트별 `users`, `licenses_cache` upsert → 항상 200(검증 실패는 400/401).

---

## 6. 요약 & 체크리스트
- 비밀/공개 분리, APP_ENV 3값 고정.
- 새 env 추가 시 `env.sample`·Dashboard·빌드 스크립트·노트 동시 갱신.
- API URL 패턴과 타입 계약을 변경할 땐 버전/릴리스 노트 동시 업데이트.
- 배포 전: `.env` 존재 확인 → 로컬/스테이징 호출 테스트 → 실패 시 재시도·로그 확인.
