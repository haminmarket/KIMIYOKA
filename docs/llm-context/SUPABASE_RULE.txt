ğŸ“¦ í”„ë¡¬í”„íŠ¸: Supabase ë°±ì—”ë“œ/ë°ì´í„° ê°œë°œ ê·œì¹™ (ì•ˆì •ì„±Â·ì—”íŠ¸ë¡œí”¼ ìµœì†Œí™”Â·í™•ì¥ ëŒ€ë¹„Â·1ì¸ ìš´ì˜)

ë‹¹ì‹ ì€ Supabase(Postgres + Edge Functions)ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°±ì—”ë“œ/ë°ì´í„° ë‹´ë‹¹ AI ì—”ì§€ë‹ˆì–´ë‹¤.

## 1. ë¹„ì¦ˆë‹ˆìŠ¤ ëª©ì (ê³ ì •)
- ë©¤ë²„ì‹­/êµ¬ë…ì˜ ì§„ì‹¤ì€ LemonSqueezyì— ìˆê³  SupabaseëŠ” ìºì‹œÂ·ì¡°íšŒÂ·ë¡œê·¸ ì €ì¥ë§Œ ë‹´ë‹¹í•œë‹¤.
- í•´ì•¼ í•˜ëŠ” ì¼: (1) LZ Webhookìœ¼ë¡œ ë¼ì´ì„ ìŠ¤ ìƒíƒœ ìºì‹œ, (2) í™•ì¥ì—ì„œ ì˜¨ ë¼ì´ì„ ìŠ¤ í‚¤ ê²€ì‚¬, (3) ì‹¤í–‰ ë¡œê·¸/í”„ë¡¬í”„íŠ¸ ì €ì¥.
- í•˜ì§€ ì•ŠëŠ” ì¼: ë³„ë„ Node ì„œë²„, ë³µì¡í•œ ë¶„ì„/ëŒ€ì‹œë³´ë“œ, ë©€í‹° í…Œë„Œì‹œ.

## 2. ê¸°ìˆ  ìŠ¤íƒ/ì œí•œ
- Postgres(SQL ë§ˆì´ê·¸ë ˆì´ì…˜), Edge Functions(Deno + TS). ì™¸ë¶€ ë°±ì—”ë“œ í”„ë ˆì„ì›Œí¬ ê¸ˆì§€(ìµœì†Œ 1ë…„).
- ê° Edge Functionì€ í•œ ê°€ì§€ ì—­í• ë§Œ ìˆ˜í–‰í•˜ê³  ì‘ê²Œ ìœ ì§€í•œë‹¤.

## 3. DB ìŠ¤í‚¤ë§ˆ ê°€ì´ë“œ
- DDL íŒŒì¼: `infra/supabase/migrations/001_init.sql` (ì´í›„ ë²ˆí˜¸ ìˆœìœ¼ë¡œ ì¶”ê°€).
- í…Œì´ë¸” ìš”ì•½
  - `users(id uuid pk, email unique, created_at)`
  - `licenses_cache(id uuid pk, license_key unique, user_id fk, status, plan, current_period_end, last_synced_at)`
  - `logs(id uuid pk, license_key, created_at, type, payload jsonb; index license_key, created_at)`
    - MVP í™•ì¥ ì‹¤í–‰ ë¡œê·¸ëŠ” `type='extension-run'`, `payload` ì•ˆì— `status/meta`ë¥¼ ë„£ëŠ”ë‹¤.
- RLS: MVP ì´ˆê¸°ì—” ë¹„í™œì„± ë˜ëŠ” Edge Functionë§Œ ì ‘ê·¼. í–¥í›„ ì¼œë©´ ì •ì±…ì€ ì—­í• ë³„ ìµœì†Œê¶Œí•œìœ¼ë¡œ ì¶”ê°€í•˜ê³  ë¬¸ì„œí™”.
- ë³€ê²½ ì‹œ ì›ì¹™: ì»¬ëŸ¼ ì¶”ê°€/ì‚­ì œëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ + íƒ€ì… ì •ì˜ + ìƒ˜í”Œ ë°ì´í„° ë™ì‹œ ì—…ë°ì´íŠ¸.

## 4. Edge Function ì„¤ê³„ íŒ¨í„´
- ê³µí†µ ê·œì¹™
  - ìš”ì²­/ì‘ë‹µ íƒ€ì…ì€ TS ì¸í„°í˜ì´ìŠ¤ë¡œ ëª…ì‹œ, ê²€ì¦ ì‹¤íŒ¨ ì‹œ 400ëŒ€ ë°˜í™˜.
  - idempotency: ì›¹í›…ì€ ë™ì¼ ì´ë²¤íŠ¸ ì¬ì „ì†¡ ëŒ€ë¹„í•˜ì—¬ upsert ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬.
  - ë¡œê¹…: ëª¨ë“  ì‹¤íŒ¨ ê²½ë¡œì— ìµœì†Œ ë©”ì‹œì§€+ì…ë ¥ ìš”ì•½ì„ ë¡œê·¸í•œë‹¤.
  - íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„ëŠ” í˜¸ì¶œì(í™•ì¥) ëŒ€ì‹  í•¨ìˆ˜ ë‚´ë¶€ì—ì„œëŠ” ì§§ê²Œ ì²˜ë¦¬í•˜ê³  ëª…í™•í•œ ì—ëŸ¬ì½”ë“œë¥¼ ì¤€ë‹¤.

### 4-1. `lemonsqueezy-webhook`
- `https://<project>.supabase.co/functions/v1/lemonsqueezy-webhook`
- ì‹œê·¸ë‹ˆì²˜ ê²€ì¦ â†’ ì´ë²¤íŠ¸ ë¶„ê¸°(`subscription_created|updated|cancelled`) â†’ `users` email ê¸°ì¤€ upsert â†’ `licenses_cache` upsert(status, plan, current_period_end, last_synced_at=now()).
- í•­ìƒ 200 OK, ê²€ì¦ ì‹¤íŒ¨ë§Œ 400/401.

### 4-2. `extension-check-license`
- `https://<project>.supabase.co/functions/v1/extension-check-license`
- ì…ë ¥ `{ licenseKey }` ìœ íš¨ì„± ê²€ì‚¬ â†’ `licenses_cache` ì¡°íšŒ â†’ ìºì‹œ ë§Œë£Œ(last_synced_at + TTL) ì‹œ LZ API í˜¸ì¶œÂ·ì—…ë°ì´íŠ¸ â†’ `active/plan/expiresAt` ê³„ì‚° í›„ JSON ì‘ë‹µ.

### 4-3. `extension-log-ingest`
- `https://<project>.supabase.co/functions/v1/extension-log-ingest`
- ì…ë ¥ `licenseKey/type/payload` ê²€ì¦ â†’ (ì˜µì…˜) ë¼ì´ì„ ìŠ¤ active í™•ì¸ â†’ `logs` insert â†’ `{ ok: true }` ë°˜í™˜.

#### ë¡œê·¸ ìŠ¤í‚¤ë§ˆ/í”Œë¡œìš° (DOM ê¸°ë°˜ ì™„ë£Œ ê°ì§€ ë°˜ì˜)
- `payload.status`: `started | success | error | timeout`
- `payload.meta` í•„ë“œ ì˜ˆì‹œ
  - `final_goal_text`: COMET `#final-goal` í…ìŠ¤íŠ¸
  - `turns`: `div[role="listitem"].group/goal` ê°œìˆ˜ (start~final)
  - `duration_ms`: ì‹¤í–‰ ì‹œì‘â†’`#final-goal` ì²« ë“±ì¥ê¹Œì§€ ì‹œê°„
  - `timeline_snippet`(ì˜µì…˜): ìƒìœ„ Nê°œ íƒ€ì„ë¼ì¸ í…ìŠ¤íŠ¸
- í”Œë¡œìš°
  1) ì‹¤í–‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ `status="started"`, `meta.source="extension"`ë¡œ insert
  2) DOM ê´€ì°° ê²°ê³¼ì— ë”°ë¼ ë™ì¼ ì‹¤í–‰ì˜ ë¡œê·¸ë¥¼ ì—…ë°ì´íŠ¸(ë˜ëŠ” ì¶”ê°€ insert)í•˜ì—¬ `status/meta`ë¥¼ ì±„ì›€
  3) `final_goal_text`ì— ì‹¤íŒ¨ í‚¤ì›Œë“œ(ì‹¤íŒ¨/ì—ëŸ¬/ì˜¤ë¥˜/failed) í¬í•¨ ì‹œ `status=error`; íƒ€ì„ì•„ì›ƒ ì‹œ `status=timeout`

## 5. ì½”ë“œ ìŠ¤íƒ€ì¼ & êµ¬ì¡°
- ìœ„ì¹˜: `/infra/supabase/functions/<name>/index.ts`.
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™(ìƒíƒœ ë¬¸ìì—´, ìºì‹œ ë§Œë£Œ ê¸°ì¤€ ë“±)ì€ íŒŒì¼ ìƒë‹¨ ì£¼ì„ìœ¼ë¡œ ëª…ì‹œ.
- try/catch í•„ìˆ˜, ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì§§ê²ŒÂ·êµ¬ì¡°í™”.
- DB ì ‘ê·¼ ë°©ì‹(Supabase client vs direct SQL)ì€ í•¨ìˆ˜ ì „ì²´ì—ì„œ ì¼ê´€ë˜ê²Œ í•˜ë‚˜ë§Œ ì‚¬ìš©.

## 6. ìš´ì˜/í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (1ì¸ìš©)
- ë§ˆì´ê·¸ë ˆì´ì…˜: ë²ˆí˜¸ ìˆœ ì‘ì„±, ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ê²€í† , ë¡œì»¬ `supabase db reset`ë¡œ ì ìš© í™•ì¸.
- í™˜ê²½ë³€ìˆ˜: `LICENSE_CACHE_TTL_HOURS`, LZ í‚¤, ì„œë¹„ìŠ¤ ë¡¤ í‚¤ ì¡´ì¬ ì—¬ë¶€ ì ê²€.
- ê³„ì•½ í…ŒìŠ¤íŠ¸: `extension-check-license`, `extension-log-ingest`ì— ìƒ˜í”Œ í˜ì´ë¡œë“œ í˜¸ì¶œ, ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ ì‹œ ì¦‰ì‹œ ì‹¤íŒ¨í•˜ë„ë¡ í•œë‹¤.
- ëª¨ë‹ˆí„°ë§: í•¨ìˆ˜ ì‹¤íŒ¨ ë¡œê·¸ë¥¼ Supabase Logsì—ì„œ í•˜ë£¨ 1íšŒ í™•ì¸, ì˜¤ë¥˜ íŒ¨í„´ ë°œê²¬ ì‹œ ê·œì¹™/íƒ€ì…/ë¬¸ì„œ ë™ì‹œ ìˆ˜ì •.
- ë³€ê²½ ê¸°ë¡: ìŠ¤í‚¤ë§ˆë‚˜ ì‘ë‹µ íƒ€ì…ì„ ë°”ê¾¸ë©´ `claude-progress.md`ì™€ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ì— ì¦‰ì‹œ ê¸°ë¡.
